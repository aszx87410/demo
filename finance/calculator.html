<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>é€€ä¼‘æ¨¡æ“¬è¨ˆç®—æ©Ÿ</title>
  <meta name="description" content="é€€ä¼‘æ¨¡æ“¬è¨ˆç®—æ©Ÿï¼šä¼°ç®—ç´¯ç©è³‡ç”¢ã€é€€ä¼‘å¹´é½¡ã€ç¬¬ä¸€å¹´æé ˜é‡‘é¡èˆ‡é€šè†¨å½±éŸ¿ã€‚" />
  <meta name="robots" content="index,follow" />
  <link rel="canonical" href="calculator.html" />
  <meta name="theme-color" content="#2563eb" />

  <meta property="og:type" content="website" />
  <meta property="og:locale" content="zh_TW" />
  <meta property="og:title" content="é€€ä¼‘æ¨¡æ“¬è¨ˆç®—æ©Ÿ" />
  <meta property="og:description" content="ä¼°ç®—ç´¯ç©åˆ°é€€ä¼‘é–€æª»ã€é€€ä¼‘å¹´é½¡èˆ‡é¦–å¹´æé ˜é‡‘é¡ï¼Œä¸¦å¯è€ƒé‡é€šè†¨ã€‚" />
  <meta property="og:image" content="og_retire.png" />
  <meta property="og:url" content="calculator.html" />
  <meta property="og:site_name" content="è²¡å‹™èˆ‡é€€ä¼‘å·¥å…·" />

  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="é€€ä¼‘æ¨¡æ“¬è¨ˆç®—æ©Ÿ" />
  <meta name="twitter:description" content="ä¼°ç®—ç´¯ç©è³‡ç”¢ã€é€€ä¼‘å¹´é½¡èˆ‡é¦–å¹´æé ˜é‡‘é¡ï¼Œä¸¦å¯è€ƒé‡é€šè†¨ã€‚" />
  <meta name="twitter:image" content="og_retire.png" />
  <style>
:root {
  --fg: #1f2328;
  --muted: #6a737d;
  --accent: #2563eb;
  --bg: #ffffff;
  --border: #e1e4e8;
}

* {
  box-sizing: border-box;
}
html,
body {
  height: 100%;
}
body {
  margin: 0;
  color: var(--fg);
  background: var(--bg);
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
    "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji",
    "Segoe UI Symbol", "Noto Color Emoji", sans-serif;
}

.container {
  max-width: 1080px;
  margin: 24px auto;
  padding: 0 16px;
}

h1 {
  margin: 0 0 16px 0;
  font-size: 24px;
}

.controls {
  display: grid;
  grid-template-columns: repeat(6, minmax(0, 1fr));
  gap: 12px;
  align-items: end;
  margin-bottom: 16px;
}

.field {
  display: flex;
  flex-direction: column;
  gap: 6px;
}
.field label {
  font-size: 12px;
  color: var(--muted);
}
.field input,
.field select {
  height: 36px;
  padding: 0 10px;
  border: 1px solid var(--border);
  border-radius: 8px;
  outline: none;
}

.actions {
  display: flex;
}
button {
  height: 36px;
  padding: 0 14px;
  border: 1px solid var(--accent);
  background: var(--accent);
  color: #fff;
  border-radius: 8px;
  cursor: pointer;
}
button:hover {
  opacity: 0.9;
}

.chart-wrap {
  background: #fff;
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 12px;
}

.table-wrap {
  margin-top: 16px;
}
table {
  width: 100%;
  border-collapse: collapse;
}
th,
td {
  padding: 8px 10px;
  border-bottom: 1px solid var(--border);
  text-align: right;
}
th:first-child,
td:first-child {
  text-align: left;
}
thead th {
  font-weight: 600;
  color: var(--muted);
}

.muted {
  color: var(--muted);
  font-variant-numeric: tabular-nums;
}

.pct-up {
  color: #16a34a;
}
.pct-down {
  color: #dc2626;
}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3"></script>
  <style>
    body { visibility: visible; }
    .highlight-row {
      background-color: #fffbeb;
      font-weight: 600;
    }
    .retired-section {
      background-color: #f0fdf4;
    }
    .result-summary {
      background: #eff6ff;
      border: 1px solid #bfdbfe;
      border-radius: 8px;
      padding: 16px;
      margin: 16px 0;
    }
    .result-summary h2 {
      margin: 0 0 12px 0;
      font-size: 18px;
      color: #1e40af;
    }
    .result-summary p {
      margin: 6px 0;
      font-size: 16px;
    }
    .result-summary .highlight {
      font-size: 20px;
      font-weight: 700;
      color: #1e40af;
    }

    /* æ‰‹æ©Ÿç‰ˆéŸ¿æ‡‰å¼å¸ƒå±€ */
    @media (max-width: 768px) {
      .controls {
        grid-template-columns: repeat(3, 1fr) !important;
      }
      
      .actions {
        grid-column: span 3;
      }

      .result-summary h2 {
        font-size: 16px;
      }

      .result-summary p {
        font-size: 14px;
      }

      .result-summary .highlight {
        font-size: 18px;
      }

      /* è¡¨æ ¼æ©«å‘æ»¾å‹• */
      .table-wrap {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      table {
        font-size: 14px;
      }

      th, td {
        padding: 6px 8px;
        white-space: nowrap;
      }
    }

    /* æ¥µå°è¢å¹• */
    @media (max-width: 480px) {
      .controls {
        grid-template-columns: repeat(2, 1fr) !important;
      }

      .actions {
        grid-column: span 2;
      }

      h1 {
        font-size: 20px;
      }

      table {
        font-size: 12px;
      }

      th, td {
        padding: 4px 6px;
      }
    }
  </style>
</head>
<body>
  <main class="container">
    <h1>é€€ä¼‘æ¨¡æ“¬è¨ˆç®—æ©Ÿ</h1>
    <p class="muted" style="margin: 6px 0 16px;">
      æ­é…é–±è®€ï¼š
      <a href="https://life.huli.tw/2025/10/13/not-so-complete-retirement-guide-1/" target="_blank">åŠç§‘å­¸é€€ä¼‘æ‰‹å†Š - Huli's blog</a>
    </p>

    <form id="calculator-form" class="controls">
      <div class="field">
        <label for="currentAge">ç¾åœ¨å¹´é½¡</label>
        <input id="currentAge" name="currentAge" type="number" min="0" max="100" step="1" value="30" required />
      </div>

      <div class="field">
        <label for="initialCapital">åˆå§‹è³‡é‡‘ï¼ˆè¬å…ƒï¼‰</label>
        <input id="initialCapital" name="initialCapital" type="number" min="0" step="1" value="100" required />
      </div>

      <div class="field">
        <label for="annualContribution">æ¯å¹´æŠ•å…¥ï¼ˆè¬å…ƒï¼‰</label>
        <input id="annualContribution" name="annualContribution" type="number" min="0" step="1" value="50" required />
      </div>

      <div class="field">
        <label for="expectedReturn">é æœŸå¹´åŒ–å ±é…¬ç‡ (%)</label>
        <input id="expectedReturn" name="expectedReturn" type="number" min="0" max="100" step="0.1" value="10" required />
      </div>

      <div class="field">
        <label for="annualExpense">é€€ä¼‘å¾Œå¹´ç”Ÿæ´»è²»ï¼ˆè¬å…ƒï¼‰</label>
        <input id="annualExpense" name="annualExpense" type="number" min="0" step="1" value="60" required />
      </div>

      <div class="field">
        <label for="withdrawalRate">é€€ä¼‘å¾Œæé ˜ç‡ (%)</label>
        <input id="withdrawalRate" name="withdrawalRate" type="number" min="0" max="100" step="0.1" value="4" required />
      </div>

      <div class="field">
        <label for="inflationRate">é€šè†¨ç‡ (%)</label>
        <input id="inflationRate" name="inflationRate" type="number" min="0" max="100" step="0.1" value="3" required />
      </div>

      <div class="actions">
        <button type="submit">è¨ˆç®—</button>
      </div>
    </form>

    <div id="result-summary"></div>

    <section class="chart-wrap" style="display: none;">
      <canvas id="chart" height="120"></canvas>
    </section>

    <section id="table-wrap" class="table-wrap"></section>
  </main>
  <script>
(() => {
  const form = document.getElementById('calculator-form');
  const chartCanvas = document.getElementById('chart');
  const tableWrap = document.getElementById('table-wrap');
  const resultSummary = document.getElementById('result-summary');
  const chartWrap = document.querySelector('.chart-wrap');

  let chartInstance = null;

  function formatWanWithUnit(value) {
    const wan = Math.floor((value || 0));
    if (wan >= 10000) {
      const yi = wan / 10000;
      return `${yi.toFixed(1)} å„„`;
    }
    return `${new Intl.NumberFormat('zh-Hant').format(wan)} è¬`;
  }

  function computeRetirement(params) {
    const {
      currentAge,
      initialCapital, // è¬å…ƒ
      annualContribution, // è¬å…ƒ
      expectedReturn, // å°æ•¸
      annualExpense, // è¬å…ƒ
      withdrawalRate, // å°æ•¸
      inflationRate // å°æ•¸
    } = params;

    // è¨ˆç®—é€€ä¼‘æ‰€éœ€ç¸½è³‡ç”¢ï¼ˆç¬¬ä¸€å¹´çš„è³¼è²·åŠ›åŸºæº–ï¼‰
    const baseRetirementTarget = annualExpense / withdrawalRate;

    const results = [];
    const currentYear = new Date().getFullYear();
    let age = currentAge;
    let year = 1;
    let calendarYear = currentYear;
    let assets = initialCapital; // è¬å…ƒ
    let totalContributions = initialCapital; // ç´¯ç©æœ¬é‡‘
    let isRetired = false;
    let retirementAge = null;
    let retirementYearTarget = null; // é”åˆ°é€€ä¼‘æ™‚çš„åç›®ç›®æ¨™
    let withdrawalAmount = annualExpense; // åˆå§‹æé ˜é‡‘é¡

    // è¨­å®šæœ€å¤§æ¨¡æ“¬å¹´æ•¸ï¼ˆé˜²æ­¢ç„¡çª®è¿´åœˆï¼‰
    const maxYears = 100;

    while (year <= maxYears) {
      // ç¬¬ä¸€å¹´ç›´æ¥è¨˜éŒ„åˆå§‹ç‹€æ…‹
      if (year === 1) {
        const nominalAssets = assets;
        const realAssets = assets; // ç¬¬ä¸€å¹´å¯¦è³ªç­‰æ–¼åç›®
        const returnRate = 0; // ç¬¬ä¸€å¹´é‚„æ²’æœ‰å ±é…¬

        results.push({
          year,
          age,
          calendarYear,
          nominalAssets,
          realAssets,
          returnRate,
          isRetired: false,
          withdrawalAmount: 0,
          totalContributions,
          retirementTargetThisYear: baseRetirementTarget,
          expectedWithdrawalIfRetire: annualExpense
        });

        year++;
        age++;
        calendarYear++;
        continue;
      }

      // è¨ˆç®—æœ¬å¹´åº¦çš„é€€ä¼‘ç›®æ¨™ï¼ˆéš¨é€šè†¨èª¿æ•´ï¼‰
      const inflationMultiplier = Math.pow(1 + inflationRate, year - 1);
      const retirementTargetThisYear = baseRetirementTarget * inflationMultiplier;

      // æª¢æŸ¥æ˜¯å¦é”åˆ°é€€ä¼‘æ¢ä»¶ï¼ˆç”¨å¯¦è³ªè³‡ç”¢æ¯”è¼ƒå¯¦è³ªç›®æ¨™ï¼Œç­‰åŒæ–¼ç”¨åç›®è³‡ç”¢æ¯”è¼ƒé€šè†¨èª¿æ•´å¾Œçš„åç›®ç›®æ¨™ï¼‰
      if (!isRetired && assets >= retirementTargetThisYear) {
        isRetired = true;
        retirementAge = age;
        retirementYearTarget = retirementTargetThisYear;
        // è¨­å®šé€€ä¼‘æ™‚çš„æé ˜é‡‘é¡ï¼ˆæŒ‰é€šè†¨èª¿æ•´ï¼‰
        withdrawalAmount = annualExpense * inflationMultiplier;
      }

      // è¨ˆç®—æœ¬å¹´åº¦è®ŠåŒ–
      if (isRetired) {
        // é€€ä¼‘å¾Œï¼šå…ˆæé ˜ï¼Œå†è¨ˆç®—å ±é…¬
        assets = assets - withdrawalAmount;
        assets = assets * (1 + expectedReturn);
        
        // ä¸‹ä¸€å¹´çš„æé ˜é‡‘é¡éš¨é€šè†¨å¢åŠ 
        const nextWithdrawalAmount = withdrawalAmount * (1 + inflationRate);
        
        const discount = Math.pow(1 + inflationRate, year - 1);
        const nominalAssets = assets;
        const realAssets = assets / discount;
        const returnRate = (nominalAssets / totalContributions) - 1;

        results.push({
          year,
          age,
          calendarYear,
          nominalAssets,
          realAssets,
          returnRate,
          isRetired: true,
          withdrawalAmount: withdrawalAmount,
          totalContributions,
          retirementTargetThisYear,
          expectedWithdrawalIfRetire: withdrawalAmount
        });

        withdrawalAmount = nextWithdrawalAmount;

        // å¦‚æœè³‡ç”¢è€—ç›¡ï¼Œåœæ­¢æ¨¡æ“¬
        if (assets <= 0) {
          break;
        }

        // æœ€å¤šæ¨¡æ“¬åˆ° 80 æ­²
        if (age >= 80) {
          break;
        }
      } else {
        // é€€ä¼‘å‰ï¼šåŠ å…¥å¹´åº¦æŠ•å…¥ï¼Œå†è¨ˆç®—å ±é…¬
        assets = assets + annualContribution;
        totalContributions += annualContribution;
        assets = assets * (1 + expectedReturn);

        const discount = Math.pow(1 + inflationRate, year - 1);
        const nominalAssets = assets;
        const realAssets = assets / discount;
        const returnRate = (nominalAssets / totalContributions) - 1;

        results.push({
          year,
          age,
          calendarYear,
          nominalAssets,
          realAssets,
          returnRate,
          isRetired: false,
          withdrawalAmount: 0,
          totalContributions,
          retirementTargetThisYear,
          // å¦‚æœæœ¬å¹´é€€ä¼‘éœ€è¦çš„æé ˜é‡‘é¡ï¼ˆç”¨æ–¼é¡¯ç¤ºï¼‰
          expectedWithdrawalIfRetire: annualExpense * inflationMultiplier
        });
      }

      year++;
      age++;
      calendarYear++;
    }

    return {
      results,
      retirementAge,
      retirementTarget: retirementYearTarget || baseRetirementTarget
    };
  }

  function renderSummary(retirementAge, retirementTarget, currentAge, baseTarget, firstYearWithdrawal, inflationRate) {
    if (retirementAge === null) {
      resultSummary.innerHTML = `
        <div class="result-summary">
          <h2>è¨ˆç®—çµæœ</h2>
          <p>âš ï¸ åœ¨æ¨¡æ“¬æœŸé–“å…§ç„¡æ³•é”åˆ°é€€ä¼‘ç›®æ¨™</p>
          <p>é€€ä¼‘æ‰€éœ€ç¸½è³‡ç”¢ï¼ˆä»Šæ—¥è³¼è²·åŠ›ï¼‰ï¼š<span class="highlight">${formatWanWithUnit(baseTarget)}</span></p>
        </div>
      `;
    } else {
      const yearsToRetirement = retirementAge - currentAge;
      const realWithdrawal = firstYearWithdrawal / Math.pow(1 + inflationRate, yearsToRetirement);
      resultSummary.innerHTML = `
        <div class="result-summary">
          <h2>âœ¨ è¨ˆç®—çµæœ</h2>
          <p>ğŸ¯ é€€ä¼‘å¹´é½¡ï¼š<span class="highlight">${retirementAge} æ­²</span></p>
          <p>â° è·é›¢é€€ä¼‘ï¼š<span class="highlight">${yearsToRetirement} å¹´</span></p>
          <p>ğŸ’° é€€ä¼‘æ™‚ç¸½è³‡ç”¢ï¼ˆåç›®ï¼‰ï¼š<span class="highlight">${formatWanWithUnit(retirementTarget)}</span></p>
          <p style="font-size: 13px; color: #6b7280; margin-top: 4px;">ï¼ˆç›¸ç•¶æ–¼ä»Šæ—¥è³¼è²·åŠ› ${formatWanWithUnit(baseTarget)}ï¼‰</p>
          <p>ğŸ“¤ é€€ä¼‘ç¬¬ä¸€å¹´æé ˜ï¼š<span class="highlight">${formatWanWithUnit(firstYearWithdrawal)}</span></p>
          <p style="font-size: 13px; color: #6b7280; margin-top: 4px;">ï¼ˆç›¸ç•¶æ–¼ä»Šæ—¥è³¼è²·åŠ› ${formatWanWithUnit(realWithdrawal)}ï¼‰</p>
        </div>
      `;
    }
  }

  function renderChart(results) {
    const labels = results.map(r => `+${r.year - 1}`);
    const realSeries = results.map(r => r.realAssets);
    // å¯¦è³ªé€€ä¼‘ç›®æ¨™ï¼ˆå›ºå®šå€¼ï¼‰
    const baseTarget = results[0]?.retirementTargetThisYear || 0;
    const realRetirementTargetSeries = results.map(() => baseTarget);
    
    // æ‰¾åˆ°é€€ä¼‘é‚£å¹´çš„ç´¢å¼•
    const retirementIndex = results.findIndex((r, idx) => idx > 0 && r.isRetired && !results[idx - 1].isRetired);

    if (chartInstance) {
      chartInstance.destroy();
      chartInstance = null;
    }

    chartWrap.style.display = '';

    const chartOptions = {
      responsive: true,
      plugins: {
        legend: { position: 'top' },
        tooltip: {
          callbacks: {
            label: (ctx) => `${ctx.dataset.label}: ${formatWanWithUnit(ctx.parsed.y)}`
          }
        }
      },
      scales: {
        y: {
          ticks: {
            callback: (v) => {
              const wan = Math.floor(v);
              if (wan >= 10000) {
                return (wan / 10000).toFixed(1) + ' å„„';
              }
              return new Intl.NumberFormat('zh-Hant').format(wan) + ' è¬';
            }
          }
        }
      }
    };

    // å¦‚æœæ‰¾åˆ°é€€ä¼‘å¹´ä»½ï¼Œæ·»åŠ å‚ç›´çº¿æ ‡æ³¨
    if (retirementIndex >= 0) {
      chartOptions.plugins.annotation = {
        annotations: {
          retirementLine: {
            type: 'line',
            xMin: retirementIndex,
            xMax: retirementIndex,
            borderColor: '#f59e0b',
            borderWidth: 2,
            borderDash: [6, 6],
            label: {
              display: true,
              content: 'ğŸ‰ é€€ä¼‘',
              position: 'start',
              backgroundColor: '#f59e0b',
              color: '#fff',
              padding: 4,
              font: {
                size: 11
              }
            }
          }
        }
      };
    }

    chartInstance = new Chart(chartCanvas.getContext('2d'), {
      type: 'line',
      data: {
        labels,
        datasets: [
          {
            label: 'ç¸½è³‡ç”¢ï¼ˆå¯¦è³ªï¼‰',
            data: realSeries,
            borderColor: '#2563eb',
            backgroundColor: 'rgba(37, 99, 235, 0.1)',
            tension: 0.2,
            yAxisID: 'y',
          },
          {
            label: 'é€€ä¼‘é–€æª»ï¼ˆå¯¦è³ªï¼‰',
            data: realRetirementTargetSeries,
            borderColor: '#16a34a',
            backgroundColor: 'transparent',
            borderDash: [8, 4],
            tension: 0,
            pointRadius: 0,
            yAxisID: 'y',
          }
        ]
      },
      options: chartOptions
    });
  }

  function renderTable(results) {
    const headers = ['å¹´ä»½', 'å¹´é½¡', 'ç¸½è³‡ç”¢ï¼ˆåç›®ï¼‰', 'ç¸½è³‡ç”¢ï¼ˆå¯¦è³ªï¼‰', 'å¹´åº¦æé ˜é‡‘é¡', 'ç‹€æ…‹'];
    const rows = results.map((r, idx) => {
      const isRetirementYear = idx > 0 && r.isRetired && !results[idx - 1].isRetired;
      const rowClass = isRetirementYear ? 'highlight-row' : (r.isRetired ? 'retired-section' : '');
      
      // æé ˜é‡‘é¡é¡¯ç¤ºé‚è¼¯
      let withdrawalText, withdrawalClass;
      if (r.isRetired) {
        // é€€ä¼‘å¾Œé¡¯ç¤ºå¯¦éš›æé ˜é‡‘é¡
        withdrawalText = formatWanWithUnit(r.withdrawalAmount);
        withdrawalClass = '';
      } else {
        // é€€ä¼‘å‰é¡¯ç¤ºé æœŸæé ˜é‡‘é¡ï¼ˆå¦‚æœé‚£ä¸€å¹´é€€ä¼‘çš„è©±ï¼‰
        withdrawalText = '(' + formatWanWithUnit(r.expectedWithdrawalIfRetire) + ')';
        withdrawalClass = 'muted';
      }
      
      return {
        className: rowClass,
        cells: [
          { text: `+${r.year - 1}` },
          { text: `${r.age} æ­²` },
          { text: formatWanWithUnit(r.nominalAssets) },
          { text: formatWanWithUnit(r.realAssets) },
          { text: withdrawalText, className: withdrawalClass },
          { text: isRetirementYear ? 'ğŸ‰ é”æˆé€€ä¼‘!' : (r.isRetired ? 'é€€ä¼‘ä¸­' : 'ç´¯ç©æœŸ'), className: isRetirementYear ? 'highlight' : 'muted' }
        ]
      };
    });

    const table = document.createElement('table');
    const thead = document.createElement('thead');
    const tbody = document.createElement('tbody');

    const trh = document.createElement('tr');
    headers.forEach(h => {
      const th = document.createElement('th');
      th.textContent = h;
      trh.appendChild(th);
    });
    thead.appendChild(trh);

    rows.forEach(row => {
      const tr = document.createElement('tr');
      if (row.className) {
        tr.className = row.className;
      }
      row.cells.forEach(cell => {
        const td = document.createElement('td');
        td.textContent = cell.text;
        if (cell.className) td.className = cell.className;
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });

    table.appendChild(thead);
    table.appendChild(tbody);
    tableWrap.innerHTML = '';
    tableWrap.appendChild(table);
  }

  function updateURLParams(params) {
    const searchParams = new URLSearchParams();
    searchParams.set('age', params.currentAge);
    searchParams.set('capital', params.initialCapital);
    searchParams.set('contribution', params.annualContribution);
    searchParams.set('return', (params.expectedReturn * 100).toFixed(1));
    searchParams.set('expense', params.annualExpense);
    searchParams.set('withdrawal', (params.withdrawalRate * 100).toFixed(1));
    searchParams.set('inflation', (params.inflationRate * 100).toFixed(1));
    
    const newURL = `${window.location.pathname}?${searchParams.toString()}`;
    window.history.pushState({}, '', newURL);
  }

  function loadParamsFromURL() {
    const searchParams = new URLSearchParams(window.location.search);
    
    if (searchParams.has('age')) {
      document.getElementById('currentAge').value = searchParams.get('age');
    }
    if (searchParams.has('capital')) {
      document.getElementById('initialCapital').value = searchParams.get('capital');
    }
    if (searchParams.has('contribution')) {
      document.getElementById('annualContribution').value = searchParams.get('contribution');
    }
    if (searchParams.has('return')) {
      document.getElementById('expectedReturn').value = searchParams.get('return');
    }
    if (searchParams.has('expense')) {
      document.getElementById('annualExpense').value = searchParams.get('expense');
    }
    if (searchParams.has('withdrawal')) {
      document.getElementById('withdrawalRate').value = searchParams.get('withdrawal');
    }
    if (searchParams.has('inflation')) {
      document.getElementById('inflationRate').value = searchParams.get('inflation');
    }
  }

  function calculate(shouldUpdateURL = true) {
    const formData = new FormData(form);
    const params = {
      currentAge: Number(formData.get('currentAge') || 30),
      initialCapital: Number(formData.get('initialCapital') || 100),
      annualContribution: Number(formData.get('annualContribution') || 50),
      expectedReturn: Number(formData.get('expectedReturn') || 10) / 100,
      annualExpense: Number(formData.get('annualExpense') || 60),
      withdrawalRate: Number(formData.get('withdrawalRate') || 4) / 100,
      inflationRate: Number(formData.get('inflationRate') || 3) / 100,
    };

    if (shouldUpdateURL) {
      updateURLParams(params);
    }

    const { results, retirementAge, retirementTarget } = computeRetirement(params);
    const baseTarget = params.annualExpense / params.withdrawalRate;
    
    // æ‰¾åˆ°ç¬¬ä¸€å¹´é€€ä¼‘çš„æé ˜é‡‘é¡
    const firstRetiredYear = results.find(r => r.isRetired);
    const firstYearWithdrawal = firstRetiredYear ? firstRetiredYear.withdrawalAmount : params.annualExpense;
    
    renderSummary(retirementAge, retirementTarget, params.currentAge, baseTarget, firstYearWithdrawal, params.inflationRate);
    renderChart(results);
    renderTable(results);
  }

  form.addEventListener('submit', (e) => {
    e.preventDefault();
    try {
      calculate();
    } catch (err) {
      alert(err.message || String(err));
    }
  });

  // åˆæ¬¡è¼‰å…¥å³è¨ˆç®—ä¸€æ¬¡
  window.addEventListener('DOMContentLoaded', () => {
    try {
      // å…ˆå¾ URL è¼‰å…¥åƒæ•¸
      loadParamsFromURL();
      // å¦‚æœ URL æœ‰åƒæ•¸ï¼Œè¨ˆç®—æ™‚ä¸å†æ›´æ–° URLï¼ˆé¿å…é‡è¤‡ï¼‰
      const hasParams = window.location.search.length > 0;
      calculate(!hasParams);
    } catch (err) {
      console.error(err);
    }
  });
})();
  </script>
</body>
</html>

