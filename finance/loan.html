<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>é ˜éŒ¢ vs è‚¡ç¥¨è³ªæŠ¼è¨ˆç®—æ©Ÿ</title>
  <meta name="description" content="é ˜éŒ¢ vs è‚¡ç¥¨è³ªæŠ¼è¨ˆç®—æ©Ÿï¼šæ¯”è¼ƒç›´æ¥æé ˜èˆ‡è‚¡ç¥¨è³ªæŠ¼åœ¨ä¸åŒå ±é…¬ç‡ã€é€šè†¨ä¸‹çš„è³‡ç”¢è®ŠåŒ–èˆ‡æ·¨å€¼ã€‚" />
  <meta name="robots" content="index,follow" />
  <link rel="canonical" href="loan.html" />
  <meta name="theme-color" content="#2563eb" />

  <meta property="og:type" content="website" />
  <meta property="og:locale" content="zh_TW" />
  <meta property="og:title" content="é ˜éŒ¢ vs è‚¡ç¥¨è³ªæŠ¼è¨ˆç®—æ©Ÿ" />
  <meta property="og:description" content="æ¯”è¼ƒç›´æ¥æé ˜èˆ‡è‚¡ç¥¨è³ªæŠ¼åœ¨ä¸åŒå ±é…¬ç‡ã€é€šè†¨ä¸‹çš„è³‡ç”¢è®ŠåŒ–èˆ‡æ·¨å€¼ã€‚" />
  <meta property="og:image" content="og_loan.png" />
  <meta property="og:url" content="loan.html" />
  <meta property="og:site_name" content="è²¡å‹™èˆ‡é€€ä¼‘å·¥å…·" />

  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="é ˜éŒ¢ vs è‚¡ç¥¨è³ªæŠ¼è¨ˆç®—æ©Ÿ" />
  <meta name="twitter:description" content="æ¯”è¼ƒç›´æ¥æé ˜èˆ‡è‚¡ç¥¨è³ªæŠ¼åœ¨ä¸åŒå ±é…¬ç‡ã€é€šè†¨ä¸‹çš„è³‡ç”¢è®ŠåŒ–èˆ‡æ·¨å€¼ã€‚" />
  <meta name="twitter:image" content="og_loan.png" />
  <style>
    :root {
    --fg: #1f2328;
    --muted: #6a737d;
    --accent: #2563eb;
    --bg: #ffffff;
    --border: #e1e4e8;
    }

    * {
    box-sizing: border-box;
    }
    html,
    body {
    height: 100%;
    }
    body {
    margin: 0;
    color: var(--fg);
    background: var(--bg);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
        "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji",
        "Segoe UI Symbol", "Noto Color Emoji", sans-serif;
    }

    .container {
    max-width: 1080px;
    margin: 24px auto;
    padding: 0 16px;
    }

    h1 {
    margin: 0 0 16px 0;
    font-size: 24px;
    }

    .controls {
    display: grid;
    grid-template-columns: repeat(6, minmax(0, 1fr));
    gap: 12px;
    align-items: end;
    margin-bottom: 16px;
    }

    .field {
    display: flex;
    flex-direction: column;
    gap: 6px;
    }
    .field label {
    font-size: 12px;
    color: var(--muted);
    }
    .field input,
    .field select {
    height: 36px;
    padding: 0 10px;
    border: 1px solid var(--border);
    border-radius: 8px;
    outline: none;
    }

    .actions {
    display: flex;
    }
    button {
    height: 36px;
    padding: 0 14px;
    border: 1px solid var(--accent);
    background: var(--accent);
    color: #fff;
    border-radius: 8px;
    cursor: pointer;
    }
    button:hover {
    opacity: 0.9;
    }

    .chart-wrap {
    background: #fff;
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px;
    }

    .table-wrap {
    margin-top: 16px;
    }
    table {
    width: 100%;
    border-collapse: collapse;
    }
    th,
    td {
    padding: 8px 10px;
    border-bottom: 1px solid var(--border);
    text-align: right;
    }
    th:first-child,
    td:first-child {
    text-align: left;
    }
    thead th {
    font-weight: 600;
    color: var(--muted);
    }

    .muted {
    color: var(--muted);
    font-variant-numeric: tabular-nums;
    }

    .pct-up {
    color: #16a34a;
    }
    .pct-down {
    color: #dc2626;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { visibility: visible; }
    
    .result-summary {
      background: #eff6ff;
      border: 1px solid #bfdbfe;
      border-radius: 8px;
      padding: 16px;
      margin: 16px 0;
    }
    .result-summary h2 {
      margin: 0 0 12px 0;
      font-size: 18px;
      color: #1e40af;
    }
    .result-summary .comparison {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-top: 12px;
    }
    .comparison-item {
      background: white;
      padding: 12px;
      border-radius: 6px;
      border: 2px solid transparent;
    }
    .comparison-item.better {
      border-color: #16a34a;
      background: #f0fdf4;
    }
    .comparison-item h3 {
      margin: 0 0 8px 0;
      font-size: 16px;
      color: #374151;
    }
    .comparison-item p {
      margin: 4px 0;
      font-size: 14px;
    }
    .comparison-item .highlight {
      font-size: 18px;
      font-weight: 700;
      color: #1e40af;
    }
    
    .table-comparison {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-top: 16px;
    }
    
    .table-section h3 {
      margin: 0 0 8px 0;
      font-size: 16px;
      color: #374151;
    }
    
    table {
      font-size: 13px;
    }
    
    th, td {
      padding: 6px 8px;
    }
    
    .positive {
      color: #16a34a;
    }
    .negative {
      color: #dc2626;
    }
    
    /* æ‰‹æ©Ÿç‰ˆéŸ¿æ‡‰å¼å¸ƒå±€ */
    @media (max-width: 768px) {
      .controls {
        grid-template-columns: repeat(3, 1fr) !important;
      }
      
      .actions {
        grid-column: span 3;
      }
      
      .comparison {
        grid-template-columns: 1fr !important;
      }
      
      .table-comparison {
        grid-template-columns: 1fr !important;
      }
      
      table {
        font-size: 11px;
      }
      
      th, td {
        padding: 4px 6px;
        white-space: nowrap;
      }
    }
    
    @media (max-width: 480px) {
      .controls {
        grid-template-columns: repeat(2, 1fr) !important;
      }
      
      .actions {
        grid-column: span 2;
      }
      
      h1 {
        font-size: 20px;
      }
    }
  </style>
</head>
<body>
  <main class="container">
    <h1>é ˜éŒ¢ vs è‚¡ç¥¨è³ªæŠ¼è¨ˆç®—æ©Ÿ</h1>
    <p class="muted" style="margin: 6px 0 16px;">
      æ­é…é–±è®€ï¼š
      <a href="https://life.huli.tw/2025/10/13/not-so-complete-retirement-guide-1/" target="_blank">åŠç§‘å­¸é€€ä¼‘æ‰‹å†Š - Huli's blog</a>
    </p>

    <form id="loan-calculator-form" class="controls">
      <div class="field">
        <label for="initialAmount">åˆå§‹é‡‘é¡ï¼ˆè¬å…ƒï¼‰</label>
        <input id="initialAmount" name="initialAmount" type="number" min="0" step="1" value="1500" required />
      </div>

      <div class="field">
        <label for="returnMode">å ±é…¬ç‡æ¨¡å¼</label>
        <select id="returnMode" name="returnMode">
          <option value="fixed" selected>å›ºå®šå ±é…¬ç‡</option>
          <option value="actual">å¯¦éš›æ¨™çš„</option>
        </select>
      </div>

      <div class="field" id="expectedReturnField">
        <label for="expectedReturn">é æœŸå¹´åŒ–å ±é…¬ç‡ (%)</label>
        <input id="expectedReturn" name="expectedReturn" type="number" min="0" max="100" step="0.1" value="10" />
      </div>

      <div class="field" id="symbolField" style="display: none;">
        <label for="symbol">æ¨™çš„</label>
        <select id="symbol" name="symbol">
          <option value="tw-0050" selected>å°ç£ 0050</option>
          <option value="tw-0050x2">å°ç£ 0050x2</option>
          <option value="jp-1306">æ—¥æœ¬ 1306</option>
          <option value="jp-1321">æ—¥æœ¬ 1321</option>
          <option value="us-vti">ç¾åœ‹ VTI</option>
          <option value="us-vt">ç¾åœ‹ VT</option>
          <option value="us-qqq">ç¾åœ‹ QQQ</option>
          <option value="us-qld">ç¾åœ‹ QLD</option>
          <option value="us-tqqq">ç¾åœ‹ TQQQ</option>
          <option value="us-brkb">ç¾åœ‹ BRKB</option>
          <option value="us-iwy">ç¾åœ‹ IWY</option>
          <option value="us-voo">ç¾åœ‹ VOO</option>
        </select>
      </div>

      <div class="field">
        <label for="annualExpense">é€€ä¼‘å¾Œå¹´ç”Ÿæ´»è²»ï¼ˆè¬å…ƒï¼‰</label>
        <input id="annualExpense" name="annualExpense" type="number" min="0" step="1" value="60" required />
      </div>

      <div class="field">
        <label for="withdrawalRate">æé ˜ç‡ (%)</label>
        <input id="withdrawalRate" name="withdrawalRate" type="number" min="0" max="100" step="0.1" value="4" required />
      </div>

      <div class="field">
        <label for="inflationRate">é€šè†¨ç‡ (%)</label>
        <input id="inflationRate" name="inflationRate" type="number" min="0" max="100" step="0.1" value="3" required />
      </div>

      <div class="actions">
        <button type="submit">è¨ˆç®—</button>
      </div>
    </form>

    <div id="result-summary"></div>

    <section class="chart-wrap" style="display: none;">
      <canvas id="chart" height="120"></canvas>
    </section>

    <div id="table-comparison" class="table-comparison"></div>
  </main>

  <script>
    (() => {
      const form = document.getElementById('loan-calculator-form');
      const chartCanvas = document.getElementById('chart');
      const chartWrap = document.querySelector('.chart-wrap');
      const resultSummary = document.getElementById('result-summary');
      const tableComparison = document.getElementById('table-comparison');
      const returnModeEl = document.getElementById('returnMode');
      const expectedReturnField = document.getElementById('expectedReturnField');
      const symbolField = document.getElementById('symbolField');

      let chartInstance = null;

      // è‚¡ç¥¨è³ªæŠ¼åƒæ•¸
      const PLEDGE_INTEREST_RATE = 0.02875; // å¹´åˆ©ç‡2.875%

      function formatWanWithUnit(value) {
        const wan = Math.floor((value || 0));
        if (Math.abs(wan) >= 10000) {
          const yi = wan / 10000;
          return `${yi.toFixed(1)} å„„`;
        }
        return `${new Intl.NumberFormat('zh-Hant').format(wan)} è¬`;
      }

      // åŠ è¼‰è‚¡ç¥¨åƒ¹æ ¼æ•¸æ“š
      async function fetchPrices(symbol) {
        const res = await fetch(`./data/stock-price/${symbol}.json`, { cache: 'no-store' });
        if (!res.ok) throw new Error('è®€å–è‚¡åƒ¹å¤±æ•—');
        const tuples = await res.json();
        return new Map(tuples.map(([y, p]) => [Number(y), Number(p)]));
      }

      // å¾åƒ¹æ ¼æ•¸æ“šè¨ˆç®—å¹´åº¦å ±é…¬ç‡
      function calculateYearlyReturns(priceMap) {
        const years = Array.from(priceMap.keys()).sort((a, b) => a - b);
        const returns = [];
        for (let i = 1; i < years.length; i++) {
          const prevPrice = priceMap.get(years[i - 1]);
          const currPrice = priceMap.get(years[i]);
          returns.push(currPrice / prevPrice - 1);
        }
        return returns;
      }

      // æ–¹æ¡ˆä¸€ï¼šç›´æ¥æé ˜
      function computeDirectWithdrawal(params) {
        const { initialAmount, returns, annualExpense, inflationRate, startYear } = params;
        const results = [];
        let assets = initialAmount;
        let yearExpense = annualExpense;
        const maxYears = Array.isArray(returns) ? returns.length : 30;

        for (let year = 1; year <= maxYears; year++) {
          // å¹´åˆæé ˜ç”Ÿæ´»è²»
          assets -= yearExpense;
          
          // å¦‚æœè³‡ç”¢ä¸è¶³ï¼Œè¨˜éŒ„ä¸¦åœæ­¢
          if (assets <= 0) {
            results.push({
              year,
              calendarYear: startYear ? startYear + year - 1 : null,
              assets: 0,
              withdrawal: yearExpense,
              returnAmount: 0,
              yearExpense
            });
            break;
          }

          // å‰©é¤˜è³‡ç”¢æŠ•è³‡ç²åˆ©ï¼ˆä½¿ç”¨è©²å¹´çš„å ±é…¬ç‡ï¼‰
          const yearReturn = Array.isArray(returns) ? returns[year - 1] : returns;
          const returnAmount = assets * yearReturn;
          assets += returnAmount;

          results.push({
            year,
            calendarYear: startYear ? startYear + year - 1 : null,
            assets,
            withdrawal: yearExpense,
            returnAmount,
            yearExpense
          });

          // ä¸‹ä¸€å¹´çš„ç”Ÿæ´»è²»éš¨é€šè†¨èª¿æ•´
          yearExpense *= (1 + inflationRate);
        }

        return results;
      }

      // æ–¹æ¡ˆäºŒï¼šè‚¡ç¥¨è³ªæŠ¼
      function computePledgeLoan(params) {
        const { initialAmount, returns, annualExpense, inflationRate, startYear } = params;
        const results = [];
        let assets = initialAmount;
        let totalLoan = 0;
        let yearExpense = annualExpense;
        const maxYears = Array.isArray(returns) ? returns.length : 30;

        for (let year = 1; year <= maxYears; year++) {
          // å…ˆè¨ˆç®—è³‡ç”¢å¢é•·ï¼ˆå¹´åˆæŠ•è³‡æ”¶ç›Šï¼Œä½¿ç”¨è©²å¹´çš„å ±é…¬ç‡ï¼‰
          const yearReturn = Array.isArray(returns) ? returns[year - 1] : returns;
          const returnAmount = assets * yearReturn;
          assets += returnAmount;
          
          // è¨ˆç®—æœ¬å¹´éœ€è¦çš„ç”Ÿæ´»è²»
          const neededAmount = yearExpense;
          
          // è¨ˆç®—æœ¬å¹´éœ€è¦å€Ÿçš„éŒ¢ï¼š
          // è¨­æœ¬å¹´å€Ÿæ¬¾ç‚º X
          // å¹´åº•ç¸½è²¸æ¬¾ = totalLoan + X
          // å¹´åº•éœ€æ”¯ä»˜çš„åˆ©æ¯ = (totalLoan + X) * åˆ©ç‡
          // å€Ÿæ¬¾éœ€è¦è¶³å¤ æ”¯ä»˜ï¼šç”Ÿæ´»è²» + å¹´åº•åˆ©æ¯
          // X = ç”Ÿæ´»è²» + (totalLoan + X) * åˆ©ç‡
          // X = ç”Ÿæ´»è²» + totalLoan * åˆ©ç‡ + X * åˆ©ç‡
          // X - X * åˆ©ç‡ = ç”Ÿæ´»è²» + totalLoan * åˆ©ç‡
          // X * (1 - åˆ©ç‡) = ç”Ÿæ´»è²» + totalLoan * åˆ©ç‡
          // X = (ç”Ÿæ´»è²» + totalLoan * åˆ©ç‡) / (1 - åˆ©ç‡)
          
          const actualBorrow = (neededAmount + totalLoan * PLEDGE_INTEREST_RATE) / (1 - PLEDGE_INTEREST_RATE);
          const borrowedForExpense = neededAmount;
          
          // æ›´æ–°ç¸½è²¸æ¬¾
          totalLoan += actualBorrow;
          
          // è¨ˆç®—å¹´åº•éœ€æ”¯ä»˜çš„åˆ©æ¯ï¼ˆåŸºæ–¼å¹´åº•çš„ç¸½è²¸æ¬¾ï¼‰
          const interest = totalLoan * PLEDGE_INTEREST_RATE;
          const borrowedForInterest = actualBorrow - neededAmount; // å€Ÿæ¬¾ä¸­ç”¨æ–¼æ”¯ä»˜åˆ©æ¯çš„éƒ¨åˆ†
          
          // è¨ˆç®—å€Ÿæ¬¾ç‡ï¼ˆç¸½å€Ÿæ¬¾/ç¸½è³‡ç”¢ï¼‰
          const loanRatio = assets > 0 ? (totalLoan / assets) : 0;

          results.push({
            year,
            calendarYear: startYear ? startYear + year - 1 : null,
            assets,
            totalLoan,
            interest,
            borrowed: actualBorrow,
            borrowedForExpense,
            borrowedForInterest,
            returnAmount,
            yearExpense,
            loanRatio
          });

          // ä¸‹ä¸€å¹´çš„ç”Ÿæ´»è²»éš¨é€šè†¨èª¿æ•´
          yearExpense *= (1 + inflationRate);
        }

        return results;
      }

      function renderSummary(directResults, pledgeResults, avgReturn) {
        const directFinalAssets = directResults.length > 0 ? directResults[directResults.length - 1].assets : 0;
        const pledgeFinalAssets = pledgeResults.length > 0 ? pledgeResults[pledgeResults.length - 1].assets : 0;
        const pledgeFinalLoan = pledgeResults.length > 0 ? pledgeResults[pledgeResults.length - 1].totalLoan : 0;
        const pledgeFinalLoanRatio = pledgeResults.length > 0 ? pledgeResults[pledgeResults.length - 1].loanRatio : 0;
        const pledgeNetAssets = pledgeFinalAssets - pledgeFinalLoan;

        const directBetter = directFinalAssets > pledgeNetAssets;
        const pledgeBetter = pledgeNetAssets > directFinalAssets;

        const directTotalInterest = 0;
        // ç¸½åˆ©æ¯æ”¯å‡º = æ‰€æœ‰å€Ÿæ¬¾ç”¨æ–¼åˆ©æ¯çš„ç¸½å’Œ
        const pledgeTotalInterest = pledgeResults.reduce((sum, r) => sum + (r.borrowedForInterest || 0), 0);

        // å¹´ä»½ç¯„åœè³‡è¨Š
        const totalYears = directResults.length;
        const firstYear = directResults.length > 0 && directResults[0].calendarYear ? directResults[0].calendarYear : null;
        const lastYear = directResults.length > 0 && directResults[directResults.length - 1].calendarYear ? directResults[directResults.length - 1].calendarYear : null;
        const yearRangeText = firstYear && lastYear ? `${firstYear}-${lastYear} (${totalYears} å¹´)` : `${totalYears} å¹´`;

        resultSummary.innerHTML = `
          <div class="result-summary">
            <h2>ğŸ“Š ${yearRangeText}å¾Œæ¯”è¼ƒçµæœ</h2>
            <p style="font-size: 14px; color: #6b7280; margin: 8px 0;">æ¨™çš„å¹³å‡å¹´åŒ–å ±é…¬ç‡ï¼š<span style="font-weight: 600; color: #2563eb;">${(avgReturn * 100).toFixed(2)}%</span></p>
            <div class="comparison">
              <div class="comparison-item ${directBetter ? 'better' : ''}">
                <h3>ğŸ’µ æ–¹æ¡ˆä¸€ï¼šç›´æ¥æé ˜</h3>
                <p>å‰©é¤˜è³‡ç”¢ï¼š<span class="highlight">${formatWanWithUnit(directFinalAssets)}</span></p>
                <p>ç¸½åˆ©æ¯æ”¯å‡ºï¼š<span class="highlight">0 è¬</span></p>
                <p style="font-size: 12px; color: #6b7280; margin-top: 8px;">æ¯å¹´å¹´åˆæé ˜ç”Ÿæ´»è²»ï¼Œå‰©é¤˜è³‡é‡‘æŠ•è³‡</p>
              </div>
              <div class="comparison-item ${pledgeBetter ? 'better' : ''}">
                <h3>ğŸ¦ æ–¹æ¡ˆäºŒï¼šè‚¡ç¥¨è³ªæŠ¼</h3>
                <p>ç¸½è³‡ç”¢ï¼š<span class="highlight">${formatWanWithUnit(pledgeFinalAssets)}</span></p>
                <p>ç¸½è²¸æ¬¾ï¼š<span class="highlight ${pledgeFinalLoan > 0 ? 'negative' : ''}">${formatWanWithUnit(pledgeFinalLoan)}</span></p>
                <p>å€Ÿæ¬¾ç‡ï¼š<span class="highlight ${pledgeFinalLoanRatio > 0.5 ? 'negative' : ''}">${(pledgeFinalLoanRatio * 100).toFixed(1)}%</span></p>
                <p>æ·¨è³‡ç”¢ï¼š<span class="highlight">${formatWanWithUnit(pledgeNetAssets)}</span></p>
                <p>ç¸½åˆ©æ¯æ”¯å‡ºï¼š<span class="highlight negative">${formatWanWithUnit(pledgeTotalInterest)}</span></p>
                <p style="font-size: 12px; color: #6b7280; margin-top: 8px;">å¹´åˆ©ç‡2.875%<br/>è‚¡ç¥¨ä¸è³£å‡ºï¼Œåˆ©æ¯ç”¨å€Ÿæ¬¾æ”¯ä»˜</p>
              </div>
            </div>
            ${directBetter ? '<p style="margin-top: 12px; font-weight: 600; color: #16a34a;">âœ… ç›´æ¥æé ˜æ–¹æ¡ˆè¼ƒå„ª</p>' : ''}
            ${pledgeBetter ? '<p style="margin-top: 12px; font-weight: 600; color: #16a34a;">âœ… è‚¡ç¥¨è³ªæŠ¼æ–¹æ¡ˆè¼ƒå„ª</p>' : ''}
            ${directFinalAssets === pledgeNetAssets ? '<p style="margin-top: 12px; font-weight: 600; color: #6b7280;">âš–ï¸ å…©æ–¹æ¡ˆçµæœç›¸åŒ</p>' : ''}
          </div>
        `;
      }

      function renderChart(directResults, pledgeResults) {
        const years = Math.max(directResults.length, pledgeResults.length);
        // ä½¿ç”¨å¯¦éš›å¹´ä»½ä½œç‚ºæ¨™ç±¤ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
        const labels = directResults.length > 0 && directResults[0].calendarYear
          ? directResults.map(r => String(r.calendarYear))
          : Array.from({ length: years }, (_, i) => `ç¬¬${i + 1}å¹´`);
        
        const directAssets = directResults.map(r => r.assets);
        const pledgeAssets = pledgeResults.map(r => r.assets);
        const pledgeNetAssets = pledgeResults.map(r => r.assets - r.totalLoan);

        if (chartInstance) {
          chartInstance.destroy();
          chartInstance = null;
        }

        chartWrap.style.display = '';

        chartInstance = new Chart(chartCanvas.getContext('2d'), {
          type: 'line',
          data: {
            labels,
            datasets: [
              {
                label: 'ç›´æ¥æé ˜ - å‰©é¤˜è³‡ç”¢',
                data: directAssets,
                borderColor: '#2563eb',
                backgroundColor: 'rgba(37, 99, 235, 0.1)',
                tension: 0.2,
              },
              {
                label: 'è‚¡ç¥¨è³ªæŠ¼ - ç¸½è³‡ç”¢',
                data: pledgeAssets,
                borderColor: '#16a34a',
                backgroundColor: 'rgba(22, 163, 74, 0.1)',
                tension: 0.2,
                borderDash: [5, 5],
              },
              {
                label: 'è‚¡ç¥¨è³ªæŠ¼ - æ·¨è³‡ç”¢',
                data: pledgeNetAssets,
                borderColor: '#dc2626',
                backgroundColor: 'rgba(220, 38, 38, 0.1)',
                tension: 0.2,
              }
            ]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: 'top' },
              tooltip: {
                callbacks: {
                  label: (ctx) => `${ctx.dataset.label}: ${formatWanWithUnit(ctx.parsed.y)}`
                }
              }
            },
            scales: {
              y: {
                ticks: {
                  callback: (v) => {
                    const wan = Math.floor(v);
                    if (wan >= 10000) {
                      return (wan / 10000).toFixed(1) + ' å„„';
                    }
                    return new Intl.NumberFormat('zh-Hant').format(wan) + ' è¬';
                  }
                }
              }
            }
          }
        });
      }

      function renderTables(directResults, pledgeResults) {
        // æ–¹æ¡ˆä¸€è¡¨æ ¼
        const directTable = document.createElement('div');
        directTable.className = 'table-section';
        directTable.innerHTML = '<h3>ğŸ’µ æ–¹æ¡ˆä¸€ï¼šç›´æ¥æé ˜</h3>';
        
        const directTableEl = document.createElement('table');
        directTableEl.innerHTML = `
          <thead>
            <tr>
              <th>å¹´ä»½</th>
              <th>æé ˜é‡‘é¡</th>
              <th>æŠ•è³‡æ”¶ç›Š</th>
              <th>å‰©é¤˜è³‡ç”¢</th>
            </tr>
          </thead>
          <tbody>
            ${directResults.map(r => `
              <tr>
                <td>${r.calendarYear ? r.calendarYear : `ç¬¬ ${r.year} å¹´`}</td>
                <td class="muted">${formatWanWithUnit(r.withdrawal)}</td>
                <td class="${r.returnAmount > 0 ? 'positive' : 'muted'}">${formatWanWithUnit(r.returnAmount)}</td>
                <td>${formatWanWithUnit(r.assets)}</td>
              </tr>
            `).join('')}
          </tbody>
        `;
        directTable.appendChild(directTableEl);

        // æ–¹æ¡ˆäºŒè¡¨æ ¼
        const pledgeTable = document.createElement('div');
        pledgeTable.className = 'table-section';
        pledgeTable.innerHTML = '<h3>ğŸ¦ æ–¹æ¡ˆäºŒï¼šè‚¡ç¥¨è³ªæŠ¼</h3>';
        
        const pledgeTableEl = document.createElement('table');
        pledgeTableEl.innerHTML = `
          <thead>
            <tr>
              <th>å¹´ä»½</th>
              <th>æŠ•è³‡æ”¶ç›Š</th>
              <th>å€Ÿæ¬¾</th>
              <th>åˆ©æ¯</th>
              <th>ç¸½å€Ÿæ¬¾</th>
              <th>å€Ÿæ¬¾ç‡</th>
              <th>ç¸½è³‡ç”¢</th>
              <th>æ·¨è³‡ç”¢</th>
            </tr>
          </thead>
          <tbody>
            ${pledgeResults.map(r => {
              const netAssets = r.assets - r.totalLoan;
              const loanRatioPercent = (r.loanRatio * 100).toFixed(1);
              const loanRatioClass = r.loanRatio > 0.5 ? 'negative' : (r.loanRatio > 0.3 ? 'muted' : 'positive');
              return `
                <tr>
                  <td>${r.calendarYear ? r.calendarYear : `ç¬¬ ${r.year} å¹´`}</td>
                  <td class="${r.returnAmount > 0 ? 'positive' : 'muted'}">${formatWanWithUnit(r.returnAmount)}</td>
                  <td class="muted">${formatWanWithUnit(r.borrowedForExpense)}</td>
                  <td class="muted">${formatWanWithUnit(r.borrowedForInterest)}</td>
                  <td class="${r.totalLoan > 0 ? 'negative' : 'muted'}">${formatWanWithUnit(r.totalLoan)}</td>
                  <td class="${loanRatioClass}">${loanRatioPercent}%</td>
                  <td>${formatWanWithUnit(r.assets)}</td>
                  <td class="${netAssets > 0 ? 'positive' : 'negative'}">${formatWanWithUnit(netAssets)}</td>
                </tr>
              `;
            }).join('')}
          </tbody>
        `;
        pledgeTable.appendChild(pledgeTableEl);

        tableComparison.innerHTML = '';
        tableComparison.appendChild(directTable);
        tableComparison.appendChild(pledgeTable);
      }

      function updateURLParams(formData) {
        const searchParams = new URLSearchParams();
        searchParams.set('amount', formData.get('initialAmount'));
        searchParams.set('mode', formData.get('returnMode'));
        
        if (formData.get('returnMode') === 'fixed') {
          searchParams.set('return', formData.get('expectedReturn'));
        } else {
          searchParams.set('symbol', formData.get('symbol'));
        }
        
        searchParams.set('expense', formData.get('annualExpense'));
        searchParams.set('withdrawal', formData.get('withdrawalRate'));
        searchParams.set('inflation', formData.get('inflationRate'));
        
        const newURL = `${window.location.pathname}?${searchParams.toString()}`;
        window.history.pushState({}, '', newURL);
      }

      function loadParamsFromURL() {
        const searchParams = new URLSearchParams(window.location.search);
        
        if (searchParams.has('amount')) {
          document.getElementById('initialAmount').value = searchParams.get('amount');
        }
        if (searchParams.has('mode')) {
          document.getElementById('returnMode').value = searchParams.get('mode');
        }
        if (searchParams.has('return')) {
          document.getElementById('expectedReturn').value = searchParams.get('return');
        }
        if (searchParams.has('symbol')) {
          document.getElementById('symbol').value = searchParams.get('symbol');
        }
        if (searchParams.has('expense')) {
          document.getElementById('annualExpense').value = searchParams.get('expense');
        }
        if (searchParams.has('withdrawal')) {
          document.getElementById('withdrawalRate').value = searchParams.get('withdrawal');
        }
        if (searchParams.has('inflation')) {
          document.getElementById('inflationRate').value = searchParams.get('inflation');
        }
      }

      async function calculate(shouldUpdateURL = true) {
        const formData = new FormData(form);
        const returnMode = formData.get('returnMode') || 'fixed';
        
        if (shouldUpdateURL) {
          updateURLParams(formData);
        }
        
        let returns;
        let startYear = null;
        let avgReturn = 0;
        
        if (returnMode === 'actual') {
          // ä½¿ç”¨å¯¦éš›æ¨™çš„æ•¸æ“š
          const symbol = formData.get('symbol') || 'tw-0050';
          const priceMap = await fetchPrices(symbol);
          returns = calculateYearlyReturns(priceMap);
          
          // è‚¡ç¥¨åƒ¹æ ¼æ˜¯å¹´åº•åƒ¹æ ¼ï¼Œæ‰€ä»¥ç¬¬ä¸€å¹´æ˜¯åŸºæº–å¹´
          // å¯¦éš›æŠ•è³‡å¾ç¬¬äºŒå¹´é–‹å§‹ï¼Œç¬¬1å¹´å ±é…¬ç‡ = ç¬¬äºŒå¹´åƒ¹æ ¼/ç¬¬ä¸€å¹´åƒ¹æ ¼ - 1
          const years = Array.from(priceMap.keys()).sort((a, b) => a - b);
          startYear = years[1]; // å¾ç¬¬äºŒå¹´é–‹å§‹
          
          // è¨ˆç®—å¹´åŒ–å ±é…¬ç‡ï¼ˆCAGRï¼‰
          const firstPrice = priceMap.get(years[0]);
          const lastPrice = priceMap.get(years[years.length - 1]);
          const totalYears = years.length - 1;
          avgReturn = Math.pow(lastPrice / firstPrice, 1 / totalYears) - 1;
        } else {
          // ä½¿ç”¨å›ºå®šå ±é…¬ç‡
          returns = Number(formData.get('expectedReturn') || 10) / 100;
          avgReturn = returns;
        }

        const params = {
          initialAmount: Number(formData.get('initialAmount') || 1500),
          returns: returns,
          annualExpense: Number(formData.get('annualExpense') || 60),
          withdrawalRate: Number(formData.get('withdrawalRate') || 4) / 100,
          inflationRate: Number(formData.get('inflationRate') || 3) / 100,
          startYear: startYear,
        };

        const directResults = computeDirectWithdrawal(params);
        const pledgeResults = computePledgeLoan(params);

        renderSummary(directResults, pledgeResults, avgReturn);
        renderChart(directResults, pledgeResults);
        renderTables(directResults, pledgeResults);
      }

      function updateReturnModeFields() {
        const mode = returnModeEl.value;
        if (mode === 'actual') {
          expectedReturnField.style.display = 'none';
          symbolField.style.display = '';
        } else {
          expectedReturnField.style.display = '';
          symbolField.style.display = 'none';
        }
      }

      form.addEventListener('submit', (e) => {
        e.preventDefault();
        calculate().catch(err => alert(err.message || String(err)));
      });

      returnModeEl.addEventListener('change', () => {
        updateReturnModeFields();
      });

      // åˆæ¬¡è¼‰å…¥å³è¨ˆç®—ä¸€æ¬¡
      window.addEventListener('DOMContentLoaded', () => {
        // å…ˆå¾ URL è¼‰å…¥åƒæ•¸
        loadParamsFromURL();
        // æ›´æ–°é¡¯ç¤º
        updateReturnModeFields();
        // å¦‚æœ URL æœ‰åƒæ•¸ï¼Œè¨ˆç®—æ™‚ä¸å†æ›´æ–° URLï¼ˆé¿å…é‡è¤‡ï¼‰
        const hasParams = window.location.search.length > 0;
        calculate(!hasParams).catch(err => console.error(err));
      });
    })();
  </script>
</body>
</html>

