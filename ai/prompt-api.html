<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="origin-trial" content="Apukgz5C+Xvk3TaAd/KH6rGIEQizXm21Qin2Bc+z4pgJzCjIQP0fNnVMUY3TQiGPkcdBrromEFZKymYqhn+V0gsAAABneyJvcmlnaW4iOiJodHRwczovL2Fzeng4NzQxMC5naXRodWIuaW86NDQzIiwiZmVhdHVyZSI6IkFJUHJvbXB0QVBJTXVsdGltb2RhbElucHV0IiwiZXhwaXJ5IjoxNzc0MzEwNDAwfQ==">
    <title>ç€è¦½å™¨å…§å»º Prompt API ç¯„ä¾‹</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            min-height: 100vh;
            box-sizing: border-box;
        }

        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .status {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: bold;
            text-align: center;
        }

        .status.checking {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status.available {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.not-available {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.downloading {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .download-section {
            text-align: center;
            margin: 20px 0;
        }

        .download-btn {
            background: linear-gradient(45deg, #74b9ff, #0984e3);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s ease;
            font-weight: bold;
        }

        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .download-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .progress-container {
            margin: 20px 0;
            background-color: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            height: 30px;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(45deg, #74b9ff, #0984e3);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }

        .chat-section {
            margin-top: 30px;
        }

        .input-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: flex-start;
        }

        .prompt-input {
            flex: 1;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            resize: vertical;
            min-height: 60px;
        }

        .prompt-input:focus {
            outline: none;
            border-color: #74b9ff;
        }

        .send-btn {
            background: linear-gradient(45deg, #74b9ff, #0984e3);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s ease;
            font-weight: bold;
        }

        .send-btn:hover:not(:disabled) {
            transform: translateY(-2px);
        }

        .send-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .response-container {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            min-height: 100px;
            white-space: pre-wrap;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #74b9ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .response-container.loading-text {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #666;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤– ç€è¦½å™¨å…§å»º Prompt API ç¯„ä¾‹</h1>
        
        <div id="status" class="status checking">
            æ­£åœ¨æª¢æŸ¥ AI æ˜¯ä¸æ˜¯èƒ½ç”¨...
        </div>

        <div id="downloadSection" class="download-section hidden">
            <p>AI æ¨¡å‹éœ€è¦ä¸‹è¼‰æ‰èƒ½ä½¿ç”¨</p>
            <button id="downloadBtn" class="download-btn">ä¸‹è¼‰ AI æ¨¡å‹</button>
            
            <div id="progressContainer" class="progress-container hidden">
                <div id="progressBar" class="progress-bar"></div>
                <div id="progressText" class="progress-text">0%</div>
            </div>
        </div>

        <div id="chatSection" class="chat-section hidden">
            <div class="input-container">
                <textarea 
                    id="promptInput" 
                    class="prompt-input" 
                    placeholder="è¼¸å…¥ä½ çš„å•é¡Œ...&#10;æŒ‰ Ctrl+Enter ç™¼é€" 
                    rows="3"
                >ä½ å¯ä»¥åšä»€éº¼ï¼Ÿ</textarea>
                <button id="sendBtn" class="send-btn">é€å‡º</button>
            </div>
            
            <div id="responseContainer" class="response-container">
                åœ¨é€™è£¡è¼¸å…¥å•é¡Œå¾Œï¼ŒAI çš„å›æ‡‰æœƒé¡¯ç¤ºåœ¨é€™è£¡...
            </div>
        </div>
    </div>

    <script>
        // DOM å…ƒç´ 
        const statusEl = document.getElementById('status');
        const downloadSection = document.getElementById('downloadSection');
        const downloadBtn = document.getElementById('downloadBtn');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const chatSection = document.getElementById('chatSection');
        const promptInput = document.getElementById('promptInput');
        const sendBtn = document.getElementById('sendBtn');
        const responseContainer = document.getElementById('responseContainer');

        // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
        function updateStatus(message, className) {
            statusEl.textContent = message;
            statusEl.className = `status ${className}`;
        }

        // é¡¯ç¤º/éš±è—å…ƒç´ 
        function toggleElement(element, show) {
            if (show) {
                element.classList.remove('hidden');
            } else {
                element.classList.add('hidden');
            }
        }

        // ä¸‹è¼‰æ™‚é–“è·Ÿè¸ªè®Šæ•¸
        let downloadStartTime = null;
        let lastUpdateTime = null;
        let lastProgress = 0;
        let progressHistory = []; // å„²å­˜æœ€è¿‘çš„é€²åº¦æ­·å²ï¼Œç”¨æ–¼æ›´æº–ç¢ºçš„é€Ÿåº¦è¨ˆç®—
        let lastDisplayedPercentage = -1; // è¨˜éŒ„ä¸Šæ¬¡é¡¯ç¤ºçš„ç™¾åˆ†æ¯”

        // æ›´æ–°ä¸‹è¼‰é€²åº¦
        function updateProgress(progress) {
            const percentage = Math.round(progress * 100);
            const currentTime = Date.now();
            
            // åˆå§‹åŒ–æ™‚é–“è¨˜éŒ„
            if (downloadStartTime === null) {
                downloadStartTime = currentTime;
                lastUpdateTime = currentTime;
                lastProgress = progress;
                progressHistory = [];
                lastDisplayedPercentage = -1;
            }
            
            // ç¸½æ˜¯æ›´æ–°é€²åº¦æ¢è¦–è¦ºæ•ˆæœ
            progressBar.style.width = `${percentage}%`;
            
            // åªåœ¨ç™¾åˆ†æ¯”è®ŠåŒ–æ™‚æ‰æ›´æ–°æ–‡å­—å’Œè¨ˆç®—å‰©é¤˜æ™‚é–“
            if (percentage !== lastDisplayedPercentage) {
                // è¨˜éŒ„é€²åº¦æ­·å²ï¼ˆä¿ç•™æœ€è¿‘30å€‹æ•¸æ“šé»ï¼‰
                progressHistory.push({
                    time: currentTime,
                    progress: progress,
                    percentage: percentage
                });
                if (progressHistory.length > 30) {
                    progressHistory.shift();
                }
                
                // è¨ˆç®—å‰©é¤˜æ™‚é–“
                let displayText = `${percentage}%`;
                
                if (percentage > 0 && percentage < 100) {
                    const elapsedTime = (currentTime - downloadStartTime) / 1000; // ç§’
                    
                    if (elapsedTime > 3 && progressHistory.length >= 3) { // è‡³å°‘ç­‰å¾…3ç§’ä¸¦æœ‰è¶³å¤ æ•¸æ“šé»å†é–‹å§‹é æ¸¬
                        // ä½¿ç”¨æœ€è¿‘çš„æ•¸æ“šé»è¨ˆç®—å¹³å‡é€Ÿåº¦ï¼ˆæ›´æº–ç¢ºï¼‰
                        const recentHistory = progressHistory.slice(-5); // ä½¿ç”¨æœ€è¿‘5å€‹æ•¸æ“šé»
                        if (recentHistory.length >= 2) {
                            const firstPoint = recentHistory[0];
                            const lastPoint = recentHistory[recentHistory.length - 1];
                            const timeSpan = (lastPoint.time - firstPoint.time) / 1000; // ç§’
                            const progressSpan = lastPoint.progress - firstPoint.progress;
                            
                            if (timeSpan > 0 && progressSpan > 0) {
                                const recentProgressRate = progressSpan / timeSpan; // æœ€è¿‘çš„é€²åº¦é€Ÿåº¦
                                const remainingProgress = 1 - progress;
                                let estimatedRemainingTime = remainingProgress / recentProgressRate; // ç§’
                                
                                // æ‡‰ç”¨ä¸€äº›å¹³æ»‘è™•ç†ï¼Œé¿å…ä¼°ç®—æ™‚é–“è·³å‹•å¤ªå¤§
                                if (estimatedRemainingTime > 3600) { // è¶…é1å°æ™‚çš„ä¼°ç®—å¯èƒ½ä¸æº–ç¢º
                                    estimatedRemainingTime = Math.min(estimatedRemainingTime, 7200); // æœ€å¤šé¡¯ç¤º2å°æ™‚
                                }
                                
                                // æ ¼å¼åŒ–å‰©é¤˜æ™‚é–“
                                const remainingTimeText = formatRemainingTime(estimatedRemainingTime);
                                displayText = `${percentage}% - é è¨ˆå‰©é¤˜: ${remainingTimeText}`;
                            }
                        }
                    } else if (elapsedTime <= 3) {
                        // åˆæœŸé¡¯ç¤ºæ­£åœ¨è¨ˆç®—
                        displayText = `${percentage}% - æ­£åœ¨è¨ˆç®—å‰©é¤˜æ™‚é–“...`;
                    }
                }
                
                progressText.textContent = displayText;
                lastDisplayedPercentage = percentage;
            }
            
            lastUpdateTime = currentTime;
            lastProgress = progress;
        }

        // æ ¼å¼åŒ–å‰©é¤˜æ™‚é–“é¡¯ç¤º
        function formatRemainingTime(seconds) {
            if (seconds < 60) {
                return `${Math.ceil(seconds)} ç§’`;
            } else if (seconds < 3600) {
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = Math.ceil(seconds % 60);
                return `${minutes} åˆ† ${remainingSeconds} ç§’`;
            } else {
                const hours = Math.floor(seconds / 3600);
                const remainingMinutes = Math.floor((seconds % 3600) / 60);
                return `${hours} å°æ™‚ ${remainingMinutes} åˆ†`;
            }
        }

        // æª¢æŸ¥ AI å¯ç”¨æ€§
        async function checkAIAvailability() {
            try {
                // æª¢æŸ¥ç€è¦½å™¨æ˜¯å¦æ”¯æ´ Prompt API
                if (!('LanguageModel' in window)) {
                    updateStatus('âŒ æ­¤ç€è¦½å™¨ä¸æ”¯æ´ Prompt API', 'not-available');
                    return;
                }
                const availability = await LanguageModel.availability();
                console.log('availability',availability);
                
                if (availability === 'unavailable') {
                    updateStatus('âŒ AI åŠŸèƒ½ä¸å¯ç”¨', 'not-available');
                } else if (availability === 'downloadable') {
                    updateStatus('â¬‡ï¸ AI éœ€è¦ä¸‹è¼‰å¾Œæ‰èƒ½ä½¿ç”¨', 'checking');
                    toggleElement(downloadSection, true);
                } else if (availability === 'available') {
                    updateStatus('âœ… AI å·²å°±ç·’ï¼', 'available');
                    toggleElement(chatSection, true);
                }
            } catch (error) {
                console.error('æª¢æŸ¥ AI å¯ç”¨æ€§æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                updateStatus('âŒ æª¢æŸ¥ AI å¯ç”¨æ€§æ™‚ç™¼ç”ŸéŒ¯èª¤', 'not-available');
            }
        }

        // ä¸‹è¼‰ AI æ¨¡å‹
        async function downloadAIModel() {
            try {
                // é‡ç½®æ™‚é–“è·Ÿè¸ªè®Šæ•¸
                downloadStartTime = null;
                lastUpdateTime = null;
                lastProgress = 0;
                progressHistory = [];
                lastDisplayedPercentage = -1;
                
                downloadBtn.disabled = true;
                downloadBtn.textContent = 'ä¸‹è¼‰ä¸­...';
                toggleElement(progressContainer, true);
                updateStatus('ğŸ“¥ æ­£åœ¨ä¸‹è¼‰ AI æ¨¡å‹ï¼Œæª”æ¡ˆæœ‰é»å¤§ï¼Œè«‹ç¢ºä¿æ˜¯ä½¿ç”¨ wifi ç¶²è·¯ä»¥åŠè«‹å‹¿é—œé–‰è¦–çª—', 'downloading');

                // æ ¹æ“šå®˜æ–¹æ–‡ä»¶ï¼Œä½¿ç”¨ monitor å›èª¿ä¾†è¿½è¹¤ä¸‹è¼‰é€²åº¦
                await LanguageModel.create({
                    monitor(m) {
                        // ç›£æ§ä¸‹è¼‰é€²åº¦
                        m.addEventListener('downloadprogress', (e) => {
                            updateProgress(e.loaded);
                            if (e.loaded >= 1) {
                                updateStatus('âœ… AI ä¸‹è¼‰å®Œæˆä¸¦å·²å°±ç·’ï¼', 'available');
                                toggleElement(downloadSection, false);
                                toggleElement(chatSection, true);
                            }
                        });
                    }
                });

            } catch (error) {
                console.error('ä¸‹è¼‰ AI æ¨¡å‹æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                updateStatus('âŒ ä¸‹è¼‰ AI æ¨¡å‹å¤±æ•—', 'not-available');
                downloadBtn.disabled = false;
                downloadBtn.textContent = 'é‡æ–°ä¸‹è¼‰';
            }
        }

        // ç™¼é€æç¤ºä¸¦ç²å–å›æ‡‰
        async function sendPrompt() {
            const prompt = promptInput.value.trim();
            if (!prompt) return;

            sendBtn.disabled = true;
            sendBtn.textContent = 'è™•ç†ä¸­...';
            
            // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            responseContainer.className = 'response-container loading-text';
            responseContainer.innerHTML = '<div class="loading"></div>æ­£åœ¨æ€è€ƒä¸­...';

            try {
                const session = await LanguageModel.create();
                const response = await session.prompt(prompt);
                
                // é¡¯ç¤ºå›æ‡‰
                responseContainer.className = 'response-container';
                responseContainer.textContent = response;
                
            } catch (error) {
                console.error('ç²å– AI å›æ‡‰æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                responseContainer.className = 'response-container';
                responseContainer.textContent = `âŒ ç™¼ç”ŸéŒ¯èª¤: ${error.message}`;
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = 'é€å‡º';
            }
        }

        // äº‹ä»¶ç›£è½å™¨
        downloadBtn.addEventListener('click', downloadAIModel);
        sendBtn.addEventListener('click', sendPrompt);
        
        promptInput.addEventListener('keydown', (e) => {
            // Ctrl+Enter æˆ– Cmd+Enter ç™¼é€è¨Šæ¯
            if (e.key === 'Enter' && (e.ctrlKey || e.metaKey) && !sendBtn.disabled) {
                e.preventDefault();
                sendPrompt();
            }
        });

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            checkAIAvailability();
        });
    </script>
</body>
</html>
